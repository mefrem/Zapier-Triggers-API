name: CI Pipeline

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [develop, main]

jobs:
  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        working-directory: ./services/api
        run: |
          poetry install

      - name: Run pytest
        working-directory: ./services/api
        run: |
          poetry run pytest --cov=src --cov-report=xml --cov-report=term

      - name: Type checking with mypy
        working-directory: ./services/api
        run: |
          poetry run mypy src/

      - name: Lint with flake8
        working-directory: ./services/api
        run: |
          poetry run flake8 src/ --max-line-length=100

      - name: Format check with black
        working-directory: ./services/api
        run: |
          poetry run black --check src/

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./services/api/coverage.xml
          flags: backend
          name: backend-coverage

  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Terraform Format Check
        working-directory: ./infrastructure/terraform
        run: terraform fmt -check -recursive

      - name: Terraform Init (Dev)
        working-directory: ./infrastructure/terraform/environments/dev
        run: terraform init -backend=false

      - name: Terraform Validate (Dev)
        working-directory: ./infrastructure/terraform/environments/dev
        run: terraform validate

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'HIGH,CRITICAL'
          exit-code: '1'

  lint:
    name: Lint Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for trailing whitespace
        run: |
          if grep -r '[[:blank:]]$' --exclude-dir={.git,.github,node_modules,.pytest_cache,__pycache__,.terraform} .; then
            echo "Found trailing whitespace"
            exit 1
          fi

      - name: Check for tabs
        run: |
          if grep -r $'\t' --exclude-dir={.git,.github,node_modules,.pytest_cache,__pycache__,.terraform} --exclude='*.md' .; then
            echo "Found tabs (use spaces)"
            exit 1
          fi

  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [test-backend, terraform-validate, security-scan, lint]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          if [ "${{ needs.test-backend.result }}" != "success" ] || \
             [ "${{ needs.terraform-validate.result }}" != "success" ] || \
             [ "${{ needs.security-scan.result }}" != "success" ] || \
             [ "${{ needs.lint.result }}" != "success" ]; then
            echo "One or more checks failed"
            exit 1
          fi
          echo "All checks passed!"
